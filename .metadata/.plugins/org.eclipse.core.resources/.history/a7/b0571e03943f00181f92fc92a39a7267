package com.yibo.dao.admin.impl;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.MapListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import com.yibo.bean.Order;
import com.yibo.bean.Orderitem;
import com.yibo.dao.admin.AdminOrderDao;
import com.yibo.utils.ManagerThreadLocal;

public class AdminOrderDaoImpl implements AdminOrderDao {

	@Override
	public int findAll(String state) throws SQLException {
		QueryRunner qr = new QueryRunner();
		String sql = "select count(*) from orders";
		//创建一个集合用于封装query方法的参数
		List<Integer> list = new ArrayList<>();
		if(state != null && !"".equals(state)){
			sql += " where state=?";
			list.add(Integer.parseInt(state));
		}
		qr.query(ManagerThreadLocal.getConnection(),sql,new ScalarHandler(),list.toArray());
		return 0;
	}

	@Override
	public List<Order> findAll(int curPage, String state, Integer pagesize) throws SQLException {
		QueryRunner qr = new QueryRunner();
		String sql = "select * from orders";
		//创建一个集合用于封装query方法的参数
		List<Integer> list = new ArrayList<>();
		//设置mysql分页查询条件
		int a = (curPage-1)*pagesize;
		if(state!=null && !"".equals(state)){
			sql += " where state=? limit ?,?";
			list.add(Integer.parseInt(state));
		}else {
			sql += " limit ?,?";
		}
		list.add(a);
		list.add(pagesize);
		
		return qr.query(ManagerThreadLocal.getConnection(),sql,new BeanListHandler<>(Order.class),list.toArray());
	}

	@Override
	public List<Map<String, Object>> findOrderByOid(String oid) throws SQLException {
		QueryRunner qr = new QueryRunner();
		String sql = "select * from orderitem o,product p where o.pid=p.pid and o.oid=?";
		return qr.query(ManagerThreadLocal.getConnection(),sql,new MapListHandler(),oid);
	}


}
